<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM64 Mobile - Single Star Records</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #e60012; /* Nintendo Red */
            --secondary-color: #4a4a4a;
            --background-color: #f4f5f7;
            --surface-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --hover-color: #f8f9fa;
            --shadow: 0 4px 8px rgba(0,0,0,0.08);
            --border-radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        
        h1, h2, h3 { margin-bottom: 1em; font-weight: 700; }
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 1.5em; font-size: 2.5rem; }
        h2 { border-bottom: 2px solid var(--border-color); padding-bottom: 0.5em; }

        .tab-links { display: flex; list-style: none; border-bottom: 2px solid var(--border-color); margin-bottom: 25px; flex-wrap: wrap; }
        .tab-links li { padding: 12px 22px; cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .tab-links li:hover { background-color: var(--hover-color); }
        .tab-links li.active-link { border-bottom-color: var(--primary-color); color: var(--primary-color); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background-color: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 25px; margin-bottom: 25px; }

        .table-container { overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 12px 15px; text-align: left; vertical-align: middle; }
        th { background-color: var(--hover-color); font-weight: 500; white-space: nowrap; }
        tbody tr:nth-child(even) { background-color: #fdfdfd; }
        tbody tr:hover { background-color: var(--hover-color); }
        
        td a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
        td a:hover { text-decoration: underline; }

        form { display: grid; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        
        input, select, button { padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; width: 100%; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(230,0,18,0.2); }

        button { background-color: var(--primary-color); color: white; border: none; cursor: pointer; font-weight: 700; transition: background-color 0.2s; text-transform: uppercase; }
        button:hover { background-color: #b8000f; }
        button.secondary { background-color: var(--secondary-color); }
        button.secondary:hover { background-color: #333; }
        .action-buttons button { margin-right: 10px; padding: 5px 10px; font-size: 0.8rem; width: auto; text-transform: none; }

        .leaderboard-list { list-style-type: decimal; padding-left: 20px; }
        .leaderboard-list li { margin-bottom: 8px; font-size: 1.1rem; }
        
        .history-selector { margin-bottom: 15px; }

        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .alert { padding: 15px; margin-bottom: 20px; border-radius: var(--border-radius); font-weight: 500; }
        .alert-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

    <div class="container">
        <h1>SM64 Mobile - Single Star Records</h1>

        <ul class="tab-links">
            <li data-tab="single" class="active-link">Single Stars</li>
            <li data-tab="mini">Minigames</li>
            <li data-tab="submit-tab">Submit Run</li>
            <li data-tab="mod" id="mod-tab-link" style="display:none;">Moderation</li>
        </ul>

        <div id="single" class="tab-content active">
            <div class="card">
                <h2>All SS WR + Leaderboard</h2>
                <div class="table-container">
                    <table id="ss-wr-table">
                        <thead>
                            <tr><th>Stage / Star</th><th>Player</th><th>Real Time</th><th>In Game Time</th><th>Version</th><th>Date</th><th>Link</th><th>Note</th></tr>
                        </thead>
                        <tbody><tr><td colspan="8"><div class="loading-spinner"></div></td></tr></tbody>
                    </table>
                </div>
                <h3>Leaderboard (Most SS WRs)</h3>
                <ul id="ss-leaderboard" class="leaderboard-list"></ul>
            </div>
            <div class="card">
                <h2>WR History</h2>
                <div class="history-selector form-group">
                    <label for="star-select">Select a Star:</label>
                    <select id="star-select"></select>
                </div>
                 <div class="table-container">
                    <table id="history-table">
                        <thead>
                            <tr><th>Player</th><th>Date</th><th>Real Time</th><th>In Game Time</th><th>Version</th><th>Platform</th><th>Verified</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="mini" class="tab-content">
             <div class="card">
                <h2>All Minigame WR + Leaderboard</h2>
                <div class="table-container">
                    <table id="mini-wr-table">
                        <thead>
                            <tr><th>Minigame Category</th><th>Player</th><th>Real Time</th><th>In Game Time</th><th>Version</th><th>Date</th><th>Link</th><th>Note</th></tr>
                        </thead>
                        <tbody><tr><td colspan="8"><div class="loading-spinner"></div></td></tr></tbody>
                    </table>
                </div>
                <h3>Leaderboard (Most Minigame WRs)</h3>
                <ul id="mini-leaderboard" class="leaderboard-list"></ul>
            </div>
            <div class="card">
                <h2>Minigame WR History</h2>
                 <div class="history-selector form-group">
                    <label for="mini-select">Select a Minigame:</label>
                    <select id="mini-select"></select>
                </div>
                 <div class="table-container">
                    <table id="mini-history-table">
                        <thead>
                            <tr><th>Player</th><th>Date</th><th>Real Time</th><th>In Game Time</th><th>Version</th><th>Platform</th><th>Verified</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="submit-tab" class="tab-content">
            <div class="card">
                <h2>Submit Run</h2>
                <div id="submit-message"></div>
                <form id="submit-form">
                    <div class="form-group"><label for="type">Type:</label><select id="type"><option value="single">Single Star</option><option value="mini">Minigame</option></select></div>
                    <div class="form-group"><label for="item-select">Star/Minigame:</label><select id="item-select"></select></div>
                    <div class="form-group"><label for="player">Player:</label><input id="player" required></div>
                    <div class="form-group"><label for="rt">Real Time (e.g., 1:23.45 or 83.45):</label><input id="rt" required></div>
                    <div class="form-group"><label for="igt">In Game Time:</label><input id="igt" required></div>
                    <div class="form-group"><label for="version">Version:</label><select id="version"><option>JP</option><option>US</option><option>PAL</option></select></div>
                    <div class="form-group"><label for="date">Date:</label><input id="date" type="date" required></div>
                    <div class="form-group"><label for="link">Link (Video Proof):</label><input id="link" type="url" required></div>
                    <div class="form-group"><label for="note">Note:</label><input id="note" placeholder="Optional notes about the run"></div>
                    <button type="submit">Submit for Review</button>
                </form>
            </div>
        </div>

        <div id="mod" class="tab-content">
            <div id="auth-card" class="card">
                <h2>Moderation Panel</h2>
                <div id="auth-message"></div>
                <form id="login-form">
                    <div class="form-group"><label for="email">Email:</label><input id="email" type="email" placeholder="Email" required></div>
                    <div class="form-group"><label for="password">Password:</label><input id="password" type="password" placeholder="Password" required></div>
                    <button type="submit" id="login">Login</button>
                </form>
                 <button type="button" id="logout" class="secondary" style="display:none; margin-top: 10px;">Logout</button>
            </div>
            <div class="card" id="pending-section" style="display:none;">
                <h3>Pending Submissions</h3>
                <div id="mod-message"></div>
                 <div class="table-container">
                    <table id="pending-table">
                        <thead>
                            <tr><th>Type</th><th>Item</th><th>Player</th><th>Time</th><th>Date</th><th>Link</th><th>Note</th><th>Actions</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- FIREBASE CONFIG ---
            const firebaseConfig = {
                apiKey: "YOUR_API_KEY", // SUBSTITUA COM SUAS CREDENCIAIS
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // --- STATIC DATA ---
            const singleStars = ['Big Bob-omb on the Summit', 'Footrace with Koopa the Quick', 'Shoot to the Island in the Sky', 'Find the 8 Red Coins', 'Mario Wings to the Sky', 'Behind Chain Chomp’s Gate', '100 Coins Star', 'Chip off Whomp’s Block', 'To the Top of the Fortress', 'Shoot into the Wild Blue', 'Red Coins on the Floating Isle', 'Fall onto the Caged Island', 'Blast Away the Wall', '100 Coins Star', 'Plunder in the Sunken Ship', 'Can the Eel Come out and Play?', 'Treasure of the Ocean Cave', 'Red Coins on the Ship Afloat', 'Blast to the Stone Pillar', 'Through the Jet Stream', '100 Coins Star', 'Slip Slidin’ Away', 'Li’l Penguin Lost', 'Big Penguin Race', 'Frosty Slide for 8 Red Coins', 'Snowman’s Lost his Head', 'Wall Kicks will Work', '100 Coins Star', 'Go on a Ghost Hunt', 'Ride Big Boo’s Merry-Go-Round', 'Secret of the Haunted Books', 'Seek the 8 Red Coins', 'Big Boo’s Balcony', 'Eye to Eye in the Secret Room', '100 Coins Star', 'Swimming Beast in the Cavern', 'Elevate for 8 Red Coins', 'Metal-Head Mario Can Move!', 'Navigating the Toxic Maze', 'A-Maze-ing Emergency Exit', 'Watch for the Rolling Rocks', '100 Coins Star', 'Boil the Big Bully', 'Bully the Bullies', '8-Coin Puzzle with 15 Pieces', 'Red-Hot Log Rolling', 'Hot-Foot-It into the Volcano', 'Elevator Tour in the Volcano', '100 Coins Star', 'In the Talons of the Big Bird', 'Shining Atop the Pyramid', 'Inside the Ancient Pyramid', 'Stand Tall on the Four Pillars', 'Free Flying for 8 Red Coins', 'Pyramid Puzzle', '100 Coins Star', 'Board Bowser’s Sub', 'Chests in the Current', 'Pole-Jumping for Red Coins', 'Through the Jet Stream', 'The Manta Ray’s Reward', 'Collect the Caps', '100 Coins Star', 'Chill with the Bully', 'Snowman’s Big Head', 'In the Deep Freeze', 'Whirl from the Freezing Pond', 'Shell Shreddin’ for 8 Red Coins', 'Into the Igloo', '100 Coins Star', 'Shocking Arrow Lifts!', 'Top O’ The Town', 'Secrets in the Shallows & Sky', 'Express Elevators–Hurry Up!', 'Go to Town for Red Coins', 'Quick Race through Downtown', '100 Coins Star', 'Scale the Mountain', 'Mystery of the Monkey Cage', 'Scary ‘Shrooms, Red Coins', 'Mysterious Mountainside', 'Breathtaking View from Bridge', 'Blast to the Lonely Mushroom', '100 Coins Star', 'Pluck the Piranha Flower', 'The Tip Top of the Huge Island', 'Rematch with Koopa the Quick', 'Five Itty Bitty Secrets', 'Wiggler’s Red Coins', 'Make Wiggler Squirm', '100 Coins Star', 'Roll into the Cage', 'The Pit and the Pendulums', 'Get a Hand', 'Stomp on the Thwomp', 'Timed Jumps on Moving Bars', 'Stop Time for Red Coins', '100 Coins Star', 'Cruiser Crossing the Rainbow', 'The Big House in the Sky', 'Coins Amassed in a Maze', 'Swingin’ in the Breeze', 'Tricky Triangles!', 'Somewhere over the Rainbow', '100 Coins Star', 'The Princess’s Secret Slide (Box Star)', 'The Princess’s Secret Slide (Under 21s Star)', 'The Secret Aquarium', 'Tower of the Wing Cap', 'Cavern of the Metal Cap', 'Vanish Cap Under the Moat', 'Wing Mario Over the Rainbow', 'Bowser in the Dark World Reds', 'Bowser in the Fire Sea Reds', 'Bowser in the Sky Reds', 'Bowser in the Dark World No Reds', 'Bowser in the Fire Sea No Reds', 'Bowser in the Sky No Reds'];
            const miniGroups = { 'Princess Secret Slide': ['No Restrictions', 'No Shortcuts', '80 Coins'], 'Footrace With Koopa The Quick': ['No Restrictions', 'No BLJ', 'No Wing Cap', 'No BLJ Or Wing Cap'], 'Rematch With Koopa The Quick': ['No Restrictions', 'No BLJ', 'No Shell Glitch', 'No Shell', 'No BLJ Or Shell Glitch', 'No BLJ Or Shell'] };
            const minigames = Object.entries(miniGroups).flatMap(([group, subs]) => subs.map(sub => `${group} - ${sub}`));
            const courses = { 'Bob-omb Battlefield': singleStars.slice(0,7), 'Whomp\'s Fortress': singleStars.slice(7,14), 'Jolly Roger Bay': singleStars.slice(14,21), 'Cool Cool Mountain': singleStars.slice(21,28), 'Big Boo\'s Haunt': singleStars.slice(28,35), 'Hazy Maze Cave': singleStars.slice(35,42), 'Lethal Lava Land': singleStars.slice(42,49), 'Shifting Sand Land': singleStars.slice(49,56), 'Dire, Dire Docks': singleStars.slice(56,63), 'Snowman\'s Land': singleStars.slice(63,70), 'Wet-Dry World': singleStars.slice(70,77), 'Tall, Tall Mountain': singleStars.slice(77,84), 'Tiny-Huge Island': singleStars.slice(84,91), 'Tick Tock Clock': singleStars.slice(91,98), 'Rainbow Ride': singleStars.slice(98,105), 'Secret & Bowser Stars': singleStars.slice(105) };
            
            // --- DOM ELEMENTS CACHE ---
            const tabLinks = document.querySelectorAll('.tab-links li');
            const modTabLink = document.getElementById('mod-tab-link');
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logout');
            const pendingSection = document.getElementById('pending-section');
            const authCard = document.getElementById('auth-card');
            const submitForm = document.getElementById('submit-form');
            
            // --- HELPER FUNCTIONS ---
            const timeToSeconds = (time) => {
                if (typeof time !== 'string' || !time) return Infinity;
                if (time.includes(':')) {
                    const parts = time.split(':').map(parseFloat);
                    return (parts[0] * 60) + parts[1];
                }
                return parseFloat(time);
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return 'N/A';
                const date = new Date(dateStr + 'T00:00:00'); // Prevent timezone issues
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            };

            const showAlert = (containerId, message, isSuccess = true) => {
                const container = document.getElementById(containerId);
                const alertType = isSuccess ? 'alert-success' : 'alert-error';
                container.innerHTML = `<div class="alert ${alertType}">${message}</div>`;
                setTimeout(() => container.innerHTML = '', 5000);
            };

            const populateSelect = (selectElement, options) => {
                selectElement.innerHTML = '';
                options.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item;
                    opt.textContent = item;
                    selectElement.add(opt);
                });
            };

            // --- UI LOGIC ---
            function switchTab(tabElement) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tabElement.dataset.tab).classList.add('active');
                tabLinks.forEach(l => l.classList.remove('active-link'));
                tabElement.classList.add('active-link');
            }

            // --- DATA FETCHING & RENDERING ---
            async function loadWRData(collectionName, items, groupings, tableBody, leaderboardList) {
                tableBody.innerHTML = '<tr><td colspan="8"><div class="loading-spinner"></div></td></tr>';
                const counts = {};
                try {
                    const promises = items.map(item => db.collection(collectionName).doc(item).get());
                    const snapshots = await Promise.all(promises);
                    const dataMap = new Map(snapshots.map(snap => [snap.id, snap.data()]));
                    tableBody.innerHTML = '';

                    for (const groupName in groupings) {
                        const headerRow = tableBody.insertRow();
                        headerRow.innerHTML = `<th colspan="8" style="background-color: #e2e3e5; text-align: center; font-weight: 700;">${groupName}</th>`;
                        
                        groupings[groupName].forEach(item => {
                            const wr = dataMap.get(item)?.currentWR;
                            const row = tableBody.insertRow();
                            const subItemName = collectionName === 'minigames' ? item.split(' - ')[1] : item;
                            row.innerHTML = `
                                <td>${subItemName}</td>
                                <td>${wr?.player || 'N/A'}</td>
                                <td>${wr?.realTime || 'N/A'}</td>
                                <td>${wr?.inGameTime || 'N/A'}</td>
                                <td>${wr?.version || 'N/A'}</td>
                                <td>${wr?.date ? formatDate(wr.date) : 'N/A'}</td>
                                <td>${wr ? `<a href="${wr.link}" target="_blank" rel="noopener noreferrer">Proof</a>` : 'N/A'}</td>
                                <td>${wr?.note || ''}</td>
                            `;
                            if (wr?.player) counts[wr.player] = (counts[wr.player] || 0) + 1;
                        });
                    }
                    updateLeaderboard(counts, leaderboardList);
                } catch (error) {
                    console.error("Error loading WR data:", error);
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">Failed to load data. Please try again later.</td></tr>';
                }
            }
            
            async function loadHistoryData(collectionName, selectedItem, tableBody) {
                tableBody.innerHTML = '<tr><td colspan="7"><div class="loading-spinner"></div></td></tr>';
                try {
                    const doc = await db.collection(collectionName).doc(selectedItem).get();
                    tableBody.innerHTML = '';
                    if (doc.exists && doc.data().history) {
                        const history = doc.data().history.sort((a,b) => timeToSeconds(a.realTime) - timeToSeconds(b.realTime));
                        history.forEach(entry => {
                            const row = tableBody.insertRow();
                            row.innerHTML = `
                                <td>${entry.player}</td>
                                <td>${entry.date ? formatDate(entry.date) : 'N/A'}</td>
                                <td>${entry.realTime}</td>
                                <td>${entry.inGameTime}</td>
                                <td>${entry.version}</td>
                                <td>${entry.platform || 'mobile'}</td>
                                <td>${entry.verified ? 'Yes' : 'No'}</td>`;
                        });
                    } else {
                         tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No history found for this item.</td></tr>';
                    }
                } catch(error) {
                    console.error("Error loading history:", error);
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Failed to load history.</td></tr>';
                }
            }
            
            function updateLeaderboard(counts, ulElement) {
                ulElement.innerHTML = '';
                const sortedPlayers = Object.entries(counts).sort((a, b) => b[1] - a[1]);
                if (sortedPlayers.length === 0) {
                    ulElement.innerHTML = '<li>No records found yet.</li>';
                    return;
                }
                sortedPlayers.forEach(([player, count]) => {
                    const li = document.createElement('li');
                    li.textContent = `${player}: ${count} WR(s)`;
                    ulElement.appendChild(li);
                });
            }

            // --- AUTH & MODERATION ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    modTabLink.style.display = 'inline-block';
                    loginForm.style.display = 'none';
                    logoutButton.style.display = 'block';
                    pendingSection.style.display = 'block';
                    loadPending();
                } else {
                    modTabLink.style.display = 'none';
                    loginForm.style.display = 'block';
                    logoutButton.style.display = 'none';
                    pendingSection.style.display = 'none';
                }
            });

            async function loadPending() {
                const tbody = document.getElementById('pending-table').querySelector('tbody');
                tbody.innerHTML = '<tr><td colspan="8"><div class="loading-spinner"></div></td></tr>';
                try {
                    const snapshot = await db.collection('pending').orderBy('submittedAt', 'asc').get();
                    tbody.innerHTML = '';
                    if (snapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No pending submissions.</td></tr>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${data.type}</td>
                            <td>${data.item}</td>
                            <td>${data.player}</td>
                            <td>${data.realTime}</td>
                            <td>${data.date ? formatDate(data.date) : 'N/A'}</td>
                            <td><a href="${data.link}" target="_blank" rel="noopener noreferrer">Proof</a></td>
                            <td>${data.note || ''}</td>
                            <td class="action-buttons">
                                <button data-id="${doc.id}" class="approve-btn">Approve</button>
                                <button data-id="${doc.id}" class="reject-btn secondary">Reject</button>
                            </td>`;
                    });
                } catch (error) {
                    console.error("Error loading pending submissions:", error);
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:red;">Failed to load submissions.</td></tr>';
                }
            }

            async function approveSubmission(id, data) {
                const col = data.type === 'single' ? 'singleStars' : 'minigames';
                const docRef = db.collection(col).doc(data.item);
                try {
                    await db.runTransaction(async (trans) => {
                        const doc = await trans.get(docRef);
                        const newSeconds = timeToSeconds(data.realTime);
                        
                        if (doc.exists && doc.data().currentWR) {
                            const currentSeconds = timeToSeconds(doc.data().currentWR.realTime);
                            if (newSeconds >= currentSeconds) {
                                throw new Error('Submitted time is not better than the current World Record.');
                            }
                        }
                        
                        let history = doc.exists ? (doc.data().history || []) : [];
                        const entry = { player: data.player, date: data.date, realTime: data.realTime, inGameTime: data.inGameTime, version: data.version, platform: data.platform, verified: true };
                        history.push(entry);
                        
                        const currentWR = { ...entry, link: data.link, note: data.note };
                        delete currentWR.platform;
                        delete currentWR.verified;
                        
                        trans.set(docRef, { currentWR, history }, { merge: true });
                    });

                    await db.collection('pending').doc(id).delete();
                    showAlert('mod-message', 'Submission approved successfully!', true);
                    loadPending();
                    loadWRData('singleStars', singleStars, courses, document.getElementById('ss-wr-table').tBodies[0], document.getElementById('ss-leaderboard'));
                    loadWRData('minigames', minigames, miniGroups, document.getElementById('mini-wr-table').tBodies[0], document.getElementById('mini-leaderboard'));
                } catch (error) {
                    console.error("Approval Error:", error);
                    showAlert('mod-message', `Error: ${error.message}`, false);
                }
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                tabLinks.forEach(link => link.addEventListener('click', () => switchTab(link)));
                
                loginForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const pass = document.getElementById('password').value;
                    auth.signInWithEmailAndPassword(email, pass).catch(err => showAlert('auth-message', err.message, false));
                });
                
                logoutButton.addEventListener('click', () => auth.signOut());
                
                submitForm.addEventListener('submit', async e => {
                    e.preventDefault();
                    const data = {
                        type: document.getElementById('type').value,
                        item: document.getElementById('item-select').value,
                        player: document.getElementById('player').value.trim(),
                        realTime: document.getElementById('rt').value.trim(),
                        inGameTime: document.getElementById('igt').value.trim(),
                        version: document.getElementById('version').value,
                        date: document.getElementById('date').value,
                        link: document.getElementById('link').value.trim(),
                        note: document.getElementById('note').value.trim(),
                        platform: 'mobile',
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    try {
                        await db.collection('pending').add(data);
                        showAlert('submit-message', 'Run submitted successfully for review!', true);
                        submitForm.reset();
                    } catch (error) {
                        showAlert('submit-message', `Error: ${error.message}`, false);
                    }
                });

                document.getElementById('type').addEventListener('change', (e) => {
                    const itemSelect = document.getElementById('item-select');
                    const list = e.target.value === 'single' ? singleStars : minigames;
                    populateSelect(itemSelect, list);
                });

                document.getElementById('star-select').addEventListener('change', (e) => {
                    loadHistoryData('singleStars', e.target.value, document.getElementById('history-table').tBodies[0]);
                });
                document.getElementById('mini-select').addEventListener('change', (e) => {
                    loadHistoryData('minigames', e.target.value, document.getElementById('mini-history-table').tBodies[0]);
                });

                document.getElementById('pending-table').addEventListener('click', async (e) => {
                    if (e.target.classList.contains('approve-btn')) {
                        const id = e.target.dataset.id;
                        const doc = await db.collection('pending').doc(id).get();
                        if (doc.exists) approveSubmission(id, doc.data());
                    }
                    if (e.target.classList.contains('reject-btn')) {
                        if (confirm('Are you sure you want to reject this submission?')) {
                            const id = e.target.dataset.id;
                            await db.collection('pending').doc(id).delete();
                            showAlert('mod-message', 'Submission rejected.', true);
                            loadPending();
                        }
                    }
                });
            }

            // --- INITIALIZATION ---
            function init() {
                switchTab(tabLinks[0]);
                setupEventListeners();

                populateSelect(document.getElementById('item-select'), singleStars);
                populateSelect(document.getElementById('star-select'), singleStars);
                populateSelect(document.getElementById('mini-select'), minigames);

                loadWRData('singleStars', singleStars, courses, document.getElementById('ss-wr-table').tBodies[0], document.getElementById('ss-leaderboard'));
                loadWRData('minigames', minigames, miniGroups, document.getElementById('mini-wr-table').tBodies[0], document.getElementById('mini-leaderboard'));
                loadHistoryData('singleStars', singleStars[0], document.getElementById('history-table').tBodies[0]);
                loadHistoryData('minigames', minigames[0], document.getElementById('mini-history-table').tBodies[0]);
            }
            
            init();
        });
    </script>
</body>
</html>
