<!DOCTYPE html>
<html lang="en">
<head>
    <title>SM64 Mobile - Single Star Records</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:hover { background-color: #f5f5f5; }
        .tab-links { list-style: none; padding: 0; margin: 0 0 20px 0; border-bottom: 1px solid #ddd; }
        .tab-links li { display: inline-block; padding: 10px 15px; cursor: pointer; }
        .tab-links li.active-link { background-color: #f2f2f2; border: 1px solid #ddd; border-bottom: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        form label { display: block; margin-bottom: 10px; }
        input, select, button { padding: 5px; margin: 5px 0; }
        #auth { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>SM64 Mobile - Single Star Records</h1>

    <ul class="tab-links">
        <li data-tab="single" class="active-link">Single Stars</li>
        <li data-tab="mini">Minigames</li>
        <li data-tab="submit-tab">Submit Run</li>
        <li data-tab="mod" id="mod-tab-link" style="display:none;">Moderation</li>
    </ul>

    <div id="single" class="tab-content active">
        <h2>All SS WR + Leaderboard</h2>
        <table id="ss-wr-table">
            <thead>
                <tr>
                    <th>Stage / Star</th>
                    <th>Player</th>
                    <th>Real Time</th>
                    <th>In Game Time</th>
                    <th>Version</th>
                    <th>Date</th>
                    <th>Link</th>
                    <th>Note</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <h3>Leaderboard of mobile players with most SS Wr's</h3>
        <ul id="ss-leaderboard"></ul>

        <h2>WR History</h2>
        <select id="star-select"></select>
        <table id="history-table">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Date</th>
                    <th>Real Time</th>
                    <th>In Game Time</th>
                    <th>Version</th>
                    <th>Platform</th>
                    <th>Verified</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="mini" class="tab-content">
        <h2>All Minigame WR + Leaderboard</h2>
        <table id="mini-wr-table">
            <thead>
                <tr>
                    <th>Minigame</th>
                    <th>Player</th>
                    <th>Real Time</th>
                    <th>In Game Time</th>
                    <th>Version</th>
                    <th>Date</th>
                    <th>Link</th>
                    <th>Note</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <h3>Leaderboard of mobile players with most Minigames Wr's</h3>
        <ul id="mini-leaderboard"></ul>

        <h2>Minigame WR History</h2>
        <select id="mini-select"></select>
        <table id="mini-history-table">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Date</th>
                    <th>Real Time</th>
                    <th>In Game Time</th>
                    <th>Version</th>
                    <th>Platform</th>
                    <th>Verified</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="submit-tab" class="tab-content">
        <h2>Submit Run</h2>
        <form id="submit-form">
            <label>Type: <select id="type">
                <option value="single">Single Star</option>
                <option value="mini">Minigame</option>
            </select></label>
            <label>Star/Minigame: <select id="item-select"></select></label>
            <label>Player: <input id="player" required></label>
            <label>Real Time: <input id="rt" required></label>
            <label>In Game Time: <input id="igt" required></label>
            <label>Version: <select id="version">
                <option>JP</option>
                <option>US</option>
                <option>PAL</option>
            </select></label>
            <label>Date: <input id="date" type="date" required></label>
            <label>Link: <input id="link" type="url" required></label>
            <label>Note: <input id="note"></label>
            <button type="submit">Submit</button>
        </form>
    </div>

    <div id="mod" class="tab-content">
        <h2>Moderation</h2>
        <div id="auth">
            <input id="email" placeholder="Email">
            <input id="password" type="password" placeholder="Password">
            <button id="login">Login</button>
            <button id="logout" style="display:none;">Logout</button>
        </div>
        <h3>Pending Submissions</h3>
        <table id="pending-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Item</th>
                    <th>Player</th>
                    <th>Real Time</th>
                    <th>In Game Time</th>
                    <th>Version</th>
                    <th>Date</th>
                    <th>Link</th>
                    <th>Note</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCHGM4Bw4w-3SM3ScVCLnLhcCI0ISTB7S0",
            authDomain: "sm64-mobile-leaderboard.firebaseapp.com",
            projectId: "sm64-mobile-leaderboard",
            storageBucket: "sm64-mobile-leaderboard.firebasestorage.app",
            messagingSenderId: "474371344168",
            appId: "1:474371344168:web:a888b644a2a0b04ec9f21d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const singleStars = [
            'Big Bob-omb on the Summit', 'Footrace with Koopa the Quick', 'Shoot to the Island in the Sky', 'Find the 8 Red Coins', 'Mario Wings to the Sky', 'Behind Chain Chomp’s Gate', '100 Coins Star',
            'Chip off Whomp’s Block', 'To the Top of the Fortress', 'Shoot into the Wild Blue', 'Red Coins on the Floating Isle', 'Fall onto the Caged Island', 'Blast Away the Wall', '100 Coins Star',
            'Plunder in the Sunken Ship', 'Can the Eel Come out and Play?', 'Treasure of the Ocean Cave', 'Red Coins on the Ship Afloat', 'Blast to the Stone Pillar', 'Through the Jet Stream', '100 Coins Star',
            'Slip Slidin’ Away', 'Li’l Penguin Lost', 'Big Penguin Race', 'Frosty Slide for 8 Red Coins', 'Snowman’s Lost his Head', 'Wall Kicks will Work', '100 Coins Star',
            'Go on a Ghost Hunt', 'Ride Big Boo’s Merry-Go-Round', 'Secret of the Haunted Books', 'Seek the 8 Red Coins', 'Big Boo’s Balcony', 'Eye to Eye in the Secret Room', '100 Coins Star',
            'Swimming Beast in the Cavern', 'Elevate for 8 Red Coins', 'Metal-Head Mario Can Move!', 'Navigating the Toxic Maze', 'A-Maze-ing Emergency Exit', 'Watch for the Rolling Rocks', '100 Coins Star',
            'Boil the Big Bully', 'Bully the Bullies', '8-Coin Puzzle with 15 Pieces', 'Red-Hot Log Rolling', 'Hot-Foot-It into the Volcano', 'Elevator Tour in the Volcano', '100 Coins Star',
            'In the Talons of the Big Bird', 'Shining Atop the Pyramid', 'Inside the Ancient Pyramid', 'Stand Tall on the Four Pillars', 'Free Flying for 8 Red Coins', 'Pyramid Puzzle', '100 Coins Star',
            'Board Bowser’s Sub', 'Chests in the Current', 'Pole-Jumping for Red Coins', 'Through the Jet Stream', 'The Manta Ray’s Reward', 'Collect the Caps', '100 Coins Star',
            'Chill with the Bully', 'Snowman’s Big Head', 'In the Deep Freeze', 'Whirl from the Freezing Pond', 'Shell Shreddin’ for 8 Red Coins', 'Into the Igloo', '100 Coins Star',
            'Shocking Arrow Lifts!', 'Top O’ The Town', 'Secrets in the Shallows & Sky', 'Express Elevators–Hurry Up!', 'Go to Town for Red Coins', 'Quick Race through Downtown', '100 Coins Star',
            'Scale the Mountain', 'Mystery of the Monkey Cage', 'Scary ‘Shrooms, Red Coins', 'Mysterious Mountainside', 'Breathtaking View from Bridge', 'Blast to the Lonely Mushroom', '100 Coins Star',
            'Pluck the Piranha Flower', 'The Tip Top of the Huge Island', 'Rematch with Koopa the Quick', 'Five Itty Bitty Secrets', 'Wiggler’s Red Coins', 'Make Wiggler Squirm', '100 Coins Star',
            'Roll into the Cage', 'The Pit and the Pendulums', 'Get a Hand', 'Stomp on the Thwomp', 'Timed Jumps on Moving Bars', 'Stop Time for Red Coins', '100 Coins Star',
            'Cruiser Crossing the Rainbow', 'The Big House in the Sky', 'Coins Amassed in a Maze', 'Swingin’ in the Breeze', 'Tricky Triangles!', 'Somewhere over the Rainbow', '100 Coins Star',
            'The Princess’s Secret Slide (Box Star)', 'The Princess’s Secret Slide (Under 21s Star)', 'The Secret Aquarium', 'Tower of the Wing Cap', 'Cavern of the Metal Cap', 'Vanish Cap Under the Moat', 'Wing Mario Over the Rainbow',
            'Bowser in the Dark World Reds', 'Bowser in the Fire Sea Reds', 'Bowser in the Sky Reds', 'Bowser in the Dark World No Reds', 'Bowser in the Fire Sea No Reds', 'Bowser in the Sky No Reds'
        ];

        const miniGroups = {
            'Princess Secret Slide': ['No Restrictions', 'No Shortcuts', '80 Coins'],
            'Footrace With Koopa The Quick': ['No Restrictions', 'No BLJ', 'No Wing Cap', 'No BLJ Or Wing Cap'],
            'Rematch With Koopa The Quick': ['No Restrictions', 'No BLJ', 'No Shell Glitch', 'No Shell', 'No BLJ Or Shell Glitch', 'No BLJ Or Shell']
        };

        const minigames = [];
        for (let group in miniGroups) {
            miniGroups[group].forEach(sub => minigames.push(`${group} - ${sub}`));
        }

        const courses = {
            'Bob-omb Battlefield': singleStars.slice(0,7),
            'Whomp\'s Fortress': singleStars.slice(7,14),
            'Jolly Roger Bay': singleStars.slice(14,21),
            'Cool Cool Mountain': singleStars.slice(21,28),
            'Big Boo\'s Haunt': singleStars.slice(28,35),
            'Hazy Maze Cave': singleStars.slice(35,42),
            'Lethal Lava Land': singleStars.slice(42,49),
            'Shifting Sand Land': singleStars.slice(49,56),
            'Dire, Dire Docks': singleStars.slice(56,63),
            'Snowman\'s Land': singleStars.slice(63,70),
            'Wet-Dry World': singleStars.slice(70,77),
            'Tall, Tall Mountain': singleStars.slice(77,84),
            'Tiny-Huge Island': singleStars.slice(84,91),
            'Tick Tock Clock': singleStars.slice(91,98),
            'Rainbow Ride': singleStars.slice(98,105),
            'Secret Stars': singleStars.slice(105)
        };

        const courseColors = ['#90EE90', '#ADD8E6', '#D3D3D3', '#87CEEB', '#FFD700', '#A52A2A', '#FF0000', '#FFFF00', '#EE82EE', '#FFB6C1', '#FFA500', '#20B2AA', '#800080', '#FF4500', '#DA70D6', '#EEE8AA'];

        function timeToSeconds(time) {
            if (typeof time !== 'string') return Infinity;
            if (time.includes(':')) {
                const [min, sec] = time.split(':').map(parseFloat);
                return min * 60 + sec;
            } else {
                return parseFloat(time);
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        window.onload = () => {
            const tabLinks = document.querySelectorAll('.tab-links li');
            tabLinks.forEach(link => {
                link.onclick = () => {
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(link.dataset.tab).classList.add('active');
                    tabLinks.forEach(l => l.classList.remove('active-link'));
                    link.classList.add('active-link');
                };
            });
            // Activate first tab
            tabLinks[0].click();

            const itemSelect = document.getElementById('item-select');
            const typeSelect = document.getElementById('type');
            typeSelect.onchange = () => {
                itemSelect.innerHTML = '';
                const list = typeSelect.value === 'single' ? singleStars : minigames;
                list.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item;
                    opt.text = item;
                    itemSelect.add(opt);
                });
            };
            typeSelect.onchange();

            const starSelect = document.getElementById('star-select');
            singleStars.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.text = item;
                starSelect.add(opt);
            });
            starSelect.onchange = loadHistory;

            const miniSelect = document.getElementById('mini-select');
            minigames.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.text = item;
                miniSelect.add(opt);
            });
            miniSelect.onchange = loadMiniHistory;

            loadSSWR();
            loadMiniWR();

            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('mod-tab-link').style.display = 'inline-block';
                    document.getElementById('login').style.display = 'none';
                    document.getElementById('logout').style.display = 'inline';
                    loadPending();
                } else {
                    document.getElementById('mod-tab-link').style.display = 'none';
                    document.getElementById('login').style.display = 'inline';
                    document.getElementById('logout').style.display = 'none';
                }
            });

            document.getElementById('login').onclick = () => {
                const email = document.getElementById('email').value;
                const pass = document.getElementById('password').value;
                auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message));
            };

            document.getElementById('logout').onclick = () => auth.signOut();

            document.getElementById('submit-form').onsubmit = e => {
                e.preventDefault();
                const data = {
                    type: typeSelect.value,
                    item: itemSelect.value,
                    player: document.getElementById('player').value,
                    realTime: document.getElementById('rt').value,
                    inGameTime: document.getElementById('igt').value,
                    version: document.getElementById('version').value,
                    date: formatDate(document.getElementById('date').value),
                    link: document.getElementById('link').value,
                    note: document.getElementById('note').value,
                    platform: 'mobile',
                    submittedAt: firebase.firestore.Timestamp.now()
                };
                db.collection('pending').add(data).then(() => alert('Submitted for review!')).catch(err => alert(err.message));
            };
        };

        function loadSSWR() {
            const tbody = document.getElementById('ss-wr-table').querySelector('tbody');
            tbody.innerHTML = '';
            const counts = {};
            const promises = singleStars.map(star => db.collection('singleStars').doc(star).get());
            Promise.all(promises).then(snaps => {
                const dataMap = new Map();
                snaps.forEach(snap => dataMap.set(snap.id, snap.data() || {}));
                let colorIdx = 0;
                for (let course in courses) {
                    const headerRow = tbody.insertRow();
                    const headerCell = headerRow.insertCell();
                    headerCell.colSpan = 8;
                    headerCell.textContent = course;
                    headerCell.style.fontWeight = 'bold';
                    headerCell.style.backgroundColor = courseColors[colorIdx++];
                    courses[course].forEach(star => {
                        const row = tbody.insertRow();
                        row.insertCell().textContent = star;
                        const d = dataMap.get(star);
                        const wr = d.currentWR;
                        if (wr) {
                            row.insertCell().textContent = wr.player;
                            row.insertCell().textContent = wr.realTime;
                            row.insertCell().textContent = wr.inGameTime;
                            row.insertCell().textContent = wr.version;
                            row.insertCell().textContent = wr.date;
                            const linkCell = row.insertCell();
                            const a = document.createElement('a');
                            a.href = wr.link;
                            a.textContent = 'Link';
                            linkCell.append(a);
                            row.insertCell().textContent = wr.note;
                            counts[wr.player] = (counts[wr.player] || 0) + 1;
                        } else {
                            for (let i = 0; i < 7; i++) row.insertCell().textContent = '';
                        }
                    });
                }
                updateLeaderboard(counts, 'ss-leaderboard');
            });
        }

        function loadMiniWR() {
            const tbody = document.getElementById('mini-wr-table').querySelector('tbody');
            tbody.innerHTML = '';
            const counts = {};
            const promises = minigames.map(mini => db.collection('minigames').doc(mini).get());
            Promise.all(promises).then(snaps => {
                const dataMap = new Map();
                snaps.forEach(snap => dataMap.set(snap.id, snap.data() || {}));
                let colorIdx = 0;
                for (let group in miniGroups) {
                    const headerRow = tbody.insertRow();
                    const headerCell = headerRow.insertCell();
                    headerCell.colSpan = 8;
                    headerCell.textContent = group;
                    headerCell.style.fontWeight = 'bold';
                    headerCell.style.backgroundColor = courseColors[colorIdx % courseColors.length];
                    colorIdx++;
                    miniGroups[group].forEach(sub => {
                        const item = `${group} - ${sub}`;
                        const row = tbody.insertRow();
                        row.insertCell().textContent = sub;
                        const d = dataMap.get(item);
                        const wr = d.currentWR;
                        if (wr) {
                            row.insertCell().textContent = wr.player;
                            row.insertCell().textContent = wr.realTime;
                            row.insertCell().textContent = wr.inGameTime;
                            row.insertCell().textContent = wr.version;
                            row.insertCell().textContent = wr.date;
                            const linkCell = row.insertCell();
                            const a = document.createElement('a');
                            a.href = wr.link;
                            a.textContent = 'Link';
                            linkCell.append(a);
                            row.insertCell().textContent = wr.note;
                            counts[wr.player] = (counts[wr.player] || 0) + 1;
                        } else {
                            for (let i = 0; i < 7; i++) row.insertCell().textContent = '';
                        }
                    });
                }
                updateLeaderboard(counts, 'mini-leaderboard');
            });
        }

        function updateLeaderboard(counts, id) {
            const ul = document.getElementById(id);
            ul.innerHTML = '';
            Object.entries(counts).sort((a, b) => b[1] - a[1]).forEach(([player, count]) => {
                const li = document.createElement('li');
                li.textContent = `${player} ${count}`;
                ul.append(li);
            });
        }

        function loadHistory() {
            const star = document.getElementById('star-select').value;
            const tbody = document.getElementById('history-table').querySelector('tbody');
            tbody.innerHTML = '';
            db.collection('singleStars').doc(star).get().then(doc => {
                if (doc.exists) {
                    const hist = doc.data().history || [];
                    hist.forEach(entry => {
                        const row = tbody.insertRow();
                        row.insertCell().textContent = entry.player;
                        row.insertCell().textContent = entry.date;
                        row.insertCell().textContent = entry.realTime;
                        row.insertCell().textContent = entry.inGameTime;
                        row.insertCell().textContent = entry.version;
                        row.insertCell().textContent = entry.platform;
                        row.insertCell().textContent = entry.verified ? 'Yes' : 'No';
                    });
                }
            });
        }

        function loadMiniHistory() {
            const mini = document.getElementById('mini-select').value;
            const tbody = document.getElementById('mini-history-table').querySelector('tbody');
            tbody.innerHTML = '';
            db.collection('minigames').doc(mini).get().then(doc => {
                if (doc.exists) {
                    const hist = doc.data().history || [];
                    hist.forEach(entry => {
                        const row = tbody.insertRow();
                        row.insertCell().textContent = entry.player;
                        row.insertCell().textContent = entry.date;
                        row.insertCell().textContent = entry.realTime;
                        row.insertCell().textContent = entry.inGameTime;
                        row.insertCell().textContent = entry.version;
                        row.insertCell().textContent = entry.platform;
                        row.insertCell().textContent = entry.verified ? 'Yes' : 'No';
                    });
                }
            });
        }

        function loadPending() {
            const tbody = document.getElementById('pending-table').querySelector('tbody');
            tbody.innerHTML = '';
            db.collection('pending').orderBy('submittedAt', 'desc').get().then(snap => {
                snap.forEach(doc => {
                    const data = doc.data();
                    const row = tbody.insertRow();
                    row.insertCell().textContent = data.type;
                    row.insertCell().textContent = data.item;
                    row.insertCell().textContent = data.player;
                    row.insertCell().textContent = data.realTime;
                    row.insertCell().textContent = data.inGameTime;
                    row.insertCell().textContent = data.version;
                    row.insertCell().textContent = data.date;
                    row.insertCell().textContent = data.link;
                    row.insertCell().textContent = data.note;
                    const actionCell = row.insertCell();
                    const approveBtn = document.createElement('button');
                    approveBtn.textContent = 'Approve';
                    approveBtn.onclick = () => approveSubmission(doc.id, data);
                    actionCell.append(approveBtn);
                    const rejectBtn = document.createElement('button');
                    rejectBtn.textContent = 'Reject';
                    rejectBtn.onclick = () => db.collection('pending').doc(doc.id).delete().then(loadPending);
                    actionCell.append(rejectBtn);
                });
            });
        }

        function approveSubmission(id, data) {
            const col = data.type === 'single' ? 'singleStars' : 'minigames';
            const docRef = db.collection(col).doc(data.item);
            db.runTransaction(trans => {
                return trans.get(docRef).then(doc => {
                    let currentSeconds = Infinity;
                    if (doc.exists && doc.data().currentWR) {
                        currentSeconds = timeToSeconds(doc.data().currentWR.realTime);
                    }
                    const newSeconds = timeToSeconds(data.realTime);
                    if (newSeconds >= currentSeconds) {
                        throw 'Not better than current WR';
                    }
                    let history = doc.exists ? (doc.data().history || []) : [];
                    const entry = {
                        player: data.player,
                        date: data.date,
                        realTime: data.realTime,
                        inGameTime: data.inGameTime,
                        version: data.version,
                        platform: data.platform,
                        verified: true
                    };
                    history.push(entry);
                    const currentWR = { ...entry, link: data.link, note: data.note };
                    delete currentWR.platform;
                    delete currentWR.verified;
                    trans.set(docRef, { currentWR, history }, { merge: true });
                });
            }).then(() => {
                db.collection('pending').doc(id).delete();
                alert('Approved!');
                loadSSWR();
                loadMiniWR();
                loadPending();
            }).catch(err => alert(err));
        }
    </script>
</body>
</html>
